(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))n(c);new MutationObserver(c=>{for(const r of c)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function o(c){const r={};return c.integrity&&(r.integrity=c.integrity),c.referrerPolicy&&(r.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?r.credentials="include":c.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(c){if(c.ep)return;c.ep=!0;const r=o(c);fetch(c.href,r)}})();const Z=["A","B","C","D","E","F","G","H"],ee=["1","2","3","4","5","6","7","8"],h=e=>e[0],B=e=>e[1],qe=(e,t)=>e+t,we=e=>{switch(e._tag){case"Castle":return"King";case"EnPassant":return"Pawn";case"Normal":return e.role}},x=e=>e==="black"?"white":"black",De=()=>({_tag:"initial"}),_e=(e,t,o)=>({_tag:"running",start_time:e,remaining_white:t,remaining_black:o}),te=(e,t)=>({_tag:"flag",color:e,other:t}),q=e=>({legalMoves:e}),D=()=>({_tag:"none"}),Qe=e=>({_tag:"role",role:e}),Ue=e=>({_tag:"move",move:e}),je=e=>{switch(e._tag){case"none":return null;case"role":return e.role;case"move":return we(e.move)}},Je=()=>({_tag:"idle"}),Ce=()=>({_tag:"compute"}),Ve=(e,t,o="")=>({_tag:"move",move:e,legals:t,status:o}),Xe=()=>Je(),Q=(e,t)=>({_tag:"hist",move:e,legals:t}),Ye=(e,t,o,n=null)=>({black:t,white:e,engineColor:o,position:n}),ze=[{_tag:"Normal",role:"Pawn",from:"A2",capture:null,to:"A3",promotion:null},{_tag:"Normal",role:"Pawn",from:"A2",capture:null,to:"A4",promotion:null},{_tag:"Normal",role:"Knight",from:"B1",capture:null,to:"A3",promotion:null},{_tag:"Normal",role:"Knight",from:"B1",capture:null,to:"C3",promotion:null},{_tag:"Normal",role:"Pawn",from:"B2",capture:null,to:"B3",promotion:null},{_tag:"Normal",role:"Pawn",from:"B2",capture:null,to:"B4",promotion:null},{_tag:"Normal",role:"Pawn",from:"C2",capture:null,to:"C3",promotion:null},{_tag:"Normal",role:"Pawn",from:"C2",capture:null,to:"C4",promotion:null},{_tag:"Normal",role:"Pawn",from:"D2",capture:null,to:"D3",promotion:null},{_tag:"Normal",role:"Pawn",from:"D2",capture:null,to:"D4",promotion:null},{_tag:"Normal",role:"Pawn",from:"E2",capture:null,to:"E3",promotion:null},{_tag:"Normal",role:"Pawn",from:"E2",capture:null,to:"E4",promotion:null},{_tag:"Normal",role:"Pawn",from:"F2",capture:null,to:"F3",promotion:null},{_tag:"Normal",role:"Pawn",from:"F2",capture:null,to:"F4",promotion:null},{_tag:"Normal",role:"Knight",from:"G1",capture:null,to:"F3",promotion:null},{_tag:"Normal",role:"Knight",from:"G1",capture:null,to:"H3",promotion:null},{_tag:"Normal",role:"Pawn",from:"G2",capture:null,to:"G3",promotion:null},{_tag:"Normal",role:"Pawn",from:"G2",capture:null,to:"G4",promotion:null},{_tag:"Normal",role:"Pawn",from:"H2",capture:null,to:"H3",promotion:null},{_tag:"Normal",role:"Pawn",from:"H2",capture:null,to:"H4",promotion:null}],L=()=>i("moveList").length%2===0?"white":"black",T=()=>x(i("gameConfig").engineColor),Ze=()=>Ye(10*60*1e3,60*1e3,"black"),et=()=>D(),be=()=>q(ze),tt=()=>"home",ot=()=>[],nt=()=>De(),ct=()=>[];let A={screen:tt(),moveList:ot(),clock:nt(),position:be(),input:et(),started:!1,engine:Xe(),engineName:"??",lockScreen:!1,outcome:null,gameConfig:Ze(),ecoResult:ct()},$=[];const f=(e,t)=>{let o=i(e);return A[e]=t(o),e!=="clock"&&(console.groupCollapsed(e),console.debug("from",o),console.debug("to",A[e]),console.groupEnd()),$.filter(([n,c])=>n==e).map(([n,c])=>c(e)),i(e)},a=(e,t)=>f(e,()=>t),i=e=>JSON.parse(JSON.stringify(A[e])),st=()=>Object.keys(A),p=(...e)=>t=>$=$.concat(e.map(o=>[o,t])),rt=e=>$=$.filter(([t,o])=>e(t)),I=(e,t)=>(t((n,c)=>{e.setAttribute(n,c.toString())}),e),u=(e,t)=>(t((n,c)=>{e.addEventListener(n,c)}),e);function _(e){for(;e.firstChild;)lt(e.firstChild);return e}function lt(e,t=!1){t||_(e);const o=e.parentNode;o&&o.removeChild(e)}const ve="none",Ne="some",Ee={tag:ve},Pe=e=>({tag:Ne,value:e}),at=e=>typeof e=="object"&&e!==null&&"tag"in e&&(e.tag===ve||e.tag===Ne),it=e=>e.tag==="none",$e=e=>t=>it(t)?Ee:Pe(e(t.value)),ut=e=>e==null?Ee:Pe(e),mt=e=>document.createElement(e),oe=e=>t=>t.appendChild(document.createTextNode(e)),U=(e,t)=>{const o=mt(e);return o.setAttribute("class",t),o},gt=e=>t=>{typeof t=="number"?oe(t.toLocaleString())(e):oe(t)(e)},pt=e=>t=>{e.appendChild(t)},ne=(e,t)=>{typeof t=="number"||typeof t=="string"?gt(e)(t):pt(e)(t)},Le=e=>t=>{at(t)?$e(o=>ne(e,o))(t):ne(e,t)},g=e=>(...t)=>{const o=Le(e);_(e),t.forEach(o)},dt=e=>t=>t.classList.contains(e),Ie=e=>t=>t.classList.add(e),ye=e=>t=>t.classList.remove(e),j=(e,t,o)=>{const n=U(e,t);return o.forEach(Le(n)),n},s=(e,...t)=>j("div",e,t),w=(e,...t)=>j("span",e,t),J=(e,t)=>I(U("input",e),o=>o("type",t)),ft=(e,t,...o)=>I(j("a",e,o),n=>n("href",t)),ht=(e,t)=>I(U("audio",e),o=>{o("src",t)}),Se=e=>e(),kt=e=>navigator.clipboard.writeText(e).catch(t=>console.warn("Failed to set cliploard",e,t)),P=s("time white active","--:--"),V=s("time black","--:--"),wt=e=>{e.append(s("clock",P,V)),ae(),le(),p("clock")(ae),p("moveList","clock")(le)};let Me=null;const ce=()=>clearInterval(Me??void 0),_t=(e,t)=>{const o=Date.now();b=0,M=e,v=0,O=t,ce(),Me=window.setInterval(()=>f("clock",n=>{const c=vt(n);return c._tag==="flag"&&ce(),c}),100),a("clock",_e(o,0,0))};let b=0,v=0,M=0,O=0;const{floor:F}=Math,S=e=>{const t=e/1e3,o=F(t%60),n=F(t/60%60),c=F(t/60/60),r=o<10?`0${o.toFixed(0)}`:`${o.toFixed(0)}`,l=n<10?`0${n.toFixed(0)}`:`${n.toFixed(0)}`,m=c<10?`0${c.toFixed(0)}`:`${c.toFixed(0)}`;return t>=3600?`${m}:${l}:${r}`:`${l}:${r}`},Ct=ye("active"),bt=Ie("active"),se=dt("active"),re=(e,t)=>t&&!se(e)?bt(e):!t&&se(e)?Ct(e):void 0,le=()=>{const e=L();re(P,e=="white"),re(V,e=="black")},ae=()=>{const e=g(P),t=g(V),o=Ie("flag"),n=i("clock");switch(n._tag){case"flag":{n.color==="white"?(o(P),t(S(n.other)),e("00:00")):(o(P),e(S(n.other)),t("00:00"));break}case"running":{t(S(n.remaining_black)),e(S(n.remaining_white));break}case"initial":{t("--:--"),e("--:--");break}}},vt=e=>{if(e._tag==="running"){let t=Date.now(),o=b+v,c=t-e.start_time-o;return Se(()=>{switch(L()){case"white":return b+=c;case"black":return v+=c}}),v>=O?te("black",M-b):b>=M?te("white",O-v):_e(e.start_time,M-b,O-v)}return{...e}},Nt=["Pawn","Bishop","Knight","Rook","Queen","King"],Et="♟",Pt="♜",$t="♞",Lt="♝",It="♛",yt="♚",Oe="♙",Te="♖",Ae="♘",Ke="♗",Be="♕",Fe="♔",St=(e,t)=>Array.isArray(t)?t.map(o=>`${e}=${encodeURIComponent(o)}`).join("&"):t==null?`${e}=`:`${e}=${encodeURIComponent(t)}`,G=(e,t)=>{const o=Object.keys(t).map(n=>St(n,t[n])).join("&");return`${e}?${o}`},Mt=ye("hidden"),R=(e,t=null,o=null,n,c,r=null)=>({_tag:"Normal",role:e,capture:n,to:c,rank:o,file:t,promotion:r}),ie=e=>({_tag:"Castle",side:e}),Ot=(e,t,o)=>e.filter(n=>{switch(n._tag){case"Castle":return!1;case"EnPassant":return t=="Pawn"&&n.to===o;default:return o===n.to&&t===n.role}}),Tt=(e,t)=>{switch(e._tag){case"Normal":{if(e.role==="Pawn")return R("Pawn",e.capture!==null?h(e.from):null,null,e.capture!==null,e.to,e.promotion);{let o=!1,n=!1,c=!1;for(const r of t)r._tag==="Normal"&&e.from!=r.from&&e.role==r.role&&e.to==r.to&&e.promotion==r.promotion&&(o=!0,B(e.from)==B(r.from)&&(c=!0),h(e.from)==h(r.from)&&(n=!0));return R(e.role,o&&(!n||c)?h(e.from):null,n?B(e.from):null,e.capture!==null,e.to,e.promotion)}}case"EnPassant":return R("Pawn",h(e.from),null,!0,e.to,null);case"Castle":return h(e.rook)<h(e.king)?ie("QueenSide"):ie("KingSide")}},ue=e=>{switch(e){case"Pawn":return"P";case"Rook":return"R";case"Knight":return"N";case"Bishop":return"B";case"Queen":return"Q";case"King":return"K"}},me=e=>{switch(e){case"Pawn":return Oe;case"Rook":return Te;case"Knight":return Ae;case"Bishop":return Ke;case"Queen":return Be;case"King":return Fe}},At=(e,t)=>{let o=[];return t._tag==="Normal"&&t.role!=="Pawn"&&(o=Ot(e,t.role,t.to)),Tt(t,o)},Kt=(e,t)=>{const o=[];switch(e._tag){case"Normal":{e.role!=="Pawn"&&o.push(t?me(e.role):ue(e.role)),e.file!==null&&o.push(e.file.toLowerCase()),e.rank!==null&&o.push(e.rank),e.capture&&o.push("x"),o.push(e.to.toLowerCase()),e.promotion!==null&&o.push("=",t?me(e.promotion):ue(e.promotion));break}case"Castle":{e.side==="KingSide"?o.push("O","-","O"):o.push("O","-","O","-","O");break}case"null":o.push("--")}return o.join("")},N=(e,t,o=!0)=>Kt(At(t,e),o),ge=(e,t)=>{const o=i("engine"),n=g(t);switch(g(e)(w("name",i("engineName"))),o._tag){case"idle":{const r=L();return r==T()?n(s("idle",`Your turn to play ${r}`)):n(s("idle",`Engine will to play ${r}`))}case"compute":return n(s("compute"));case"move":return n(N(o.move,o.legals)+o.status)}},Bt=e=>{const t=s("info"),o=s("state"),n=u(s("engine",t,o),c=>c("click",()=>a("screen","movelist")));p("engine","engineName")(()=>ge(t,o)),ge(t,o),e.append(n)},Ft="/play/assets/chess-DAqMTTBD.ogg",Re=I(ht("-",Ft),e=>e("preload","auto"));document.body.append(Re);const Rt=()=>{Re.play()};let k=null;const Ht=()=>{const{position:e,engineColor:t,black:o,white:n}=i("gameConfig"),c=document.location.hostname,r=c!=="localhost"&&c!=="127.0.0.1"?"wss":"ws",l=document.location.port.length>0&&document.location.port!=="8000"?"8000":document.location.port,m=l.length>0?`${r}://${c}:${l}/engine`:`${r}://${c}/engine`;return G(m,{engine_color:t,fen:e,white_time:n,black_time:o})},xt=e=>{a("started",!0),a("engineName",e.name),a("position",q(e.legalMoves)),e.turn===i("gameConfig").engineColor&&a("engine",Ce())},Gt=e=>{console.log("handlePosition",e),a("position",q(e.legalMoves))},Wt=e=>{console.log("handleEngineMove",e),Rt(),a("engine",Ve(e.move,e.from,e.status)),f("moveList",t=>t.concat(Q(e.move,e.from)))},qt=e=>{console.log("handleOutcome",e),console.log("Outcome",e.outcome),a("started",!1),a("outcome",e.outcome),a("screen","movelist")},Dt=e=>{const t=JSON.parse(e.data);switch(t._tag){case"Ready":return xt(t);case"Position":return Gt(t);case"EngineMove":return Wt(t);case"Outcome":return qt(t)}},Qt=4e3,X=()=>new Promise((e,t)=>{const o=setTimeout(()=>t("Timeout error"),Qt);k=new WebSocket(Ht()),k.addEventListener("open",()=>{clearTimeout(o),e("Ready")}),k.addEventListener("message",Dt),k.addEventListener("close",()=>{k=null,a("started",!1)})}),Ut=e=>{if(i("started"))if(k===null)console.error("sending move on null socket");else{const t=i("clock");a("engine",Ce()),t._tag==="running"&&(k.send(JSON.stringify({_tag:"Move",move:e,white_time:t.remaining_white,black_time:t.remaining_black})),a("input",D()))}else console.error("game has not started")},jt=(e,t)=>{switch(e){case"Pawn":return t==="black"?Et:Oe;case"Rook":return t==="black"?Pt:Te;case"Knight":return t==="black"?$t:Ae;case"Bishop":return t==="black"?Lt:Ke;case"Queen":return t==="black"?It:Be;case"King":return t==="black"?yt:Fe}},Jt=(e,t)=>t.some(o=>{switch(o._tag){case"Normal":return o.role===e;case"Castle":return e==="King";case"EnPassant":return e==="Pawn"}}),Vt=e=>e?"selected":"",Xt=(e,t)=>Nt.map(o=>u(s(`piece ${o}  ${Vt(e===o)}`,jt(o,Jt(o,t)?"black":"white")),n=>n("click",()=>a("input",Qe(o))))),Yt=e=>{a("input",Ue(e)),f("moveList",t=>t.concat(Q(e,i("position").legalMoves))),Ut(e)},zt=e=>t=>e.filter(o=>{switch(o._tag){case"Castle":{switch(t){case"G1":return o.king==="E1"&&o.rook=="H1";case"C1":return o.king==="E1"&&o.rook=="A1";case"G8":return o.king==="E8"&&o.rook=="H8";case"C8":return o.king==="E8"&&o.rook=="A8"}return!1}case"Normal":case"EnPassant":return o.to===t}}),Zt=(e,t)=>{const o=t.filter(d=>we(d)===e),n=zt(o),c=T()==="black"?ee:ee.slice(0).reverse(),r=T()==="white"?Z:Z.slice(0).reverse(),l=s("rank",...[s("ord")].concat(r.map(d=>s("ord",d.toLowerCase()))).concat(s("ord"))),m=s("select hidden"),E=g(m),K=d=>{E(...d.map(y=>u(s("move",N(y,t)),C=>C("click",()=>Yt(y))))),Mt(m)},Ge=c.map(d=>s(`rank ${d}`,s("ord",d),...r.map(y=>{const C=qe(y,d),z=n(C);return z.length==0?s(`square ${C}`):u(s(`square ${C} target`,s("label",C.toLowerCase())),We=>We("click",()=>{K(z)}))}),s("ord")));return[m,...Ge.concat(l)]},eo=e=>{const t=s("pieces"),o=s("moves"),n=s("input",o,t);e.append(n);const c=()=>{if(L()===T()){const r=g(t),l=g(o),m=i("position"),E=i("input"),K=je(E);r(...Xt(K,m.legalMoves)),E._tag==="role"?l(...Zt(E.role,m.legalMoves)):_(o)}else _(o),_(t)};p("position","input","moveList")(c),c()},Y=(e=[])=>{const{white:t,black:o}=i("gameConfig");a("position",be()),a("input",D()),a("moveList",e),_t(t,o)},to=e=>{Bt(e),eo(e),wt(e)},oo=u(s("button-play","play"),e=>e("click",()=>X().then(()=>{Y(),a("screen","game")}).catch(t=>console.error("Connectin failed",t)))),no=u(s("button-config","config"),e=>e("click",()=>a("screen","config"))),co=s("footer",ft("link","https://github.com/pierremarc/ucui","Source code & feedback")),so=s("intro",w("ucui","µcui "),`
  is there to train or play with a chess engine over the board, 
  when the purse can't afford a fine electronic chess set. 
  It aims to be as little disruptive as possible, please 
  try and give us feedback. 
    `),pe=e=>{e.append(s("home",so,oo,no,co))},ro="wakeLock"in navigator,lo=()=>{if(ro){const e=p(...st());let t=null;e(()=>{const o=i("started"),n=i("lockScreen");o&&!n?navigator.wakeLock.request("screen").then(c=>{t=c,t.addEventListener("release",()=>{console.log("Navigator released lock sentinel"),a("lockScreen",!1)}),a("lockScreen",!0)}).catch(c=>console.error("failed to lock screen",c)):!o&&n&&t!==null&&t.release().then(()=>{t=null,a("lockScreen",!1)}).catch(c=>console.error("failed to release screen",c))})}},He=(e,t)=>{const o=[[]];for(let n=0;n<t.length;n++){let c=Math.floor(n/e);c===o.length&&o.push([]),o[c].push(t[n])}return o},ao={_tag:"pending"},io=e=>He(2,e).map((t,o)=>{const n=t[0],c=t[1];return n&&c?`${o+1}. ${N(n.move,n.legals,!1)} ${N(c.move,c.legals,!1)} `:n?`${o+1}. ${N(n.move,n.legals,!1)} `:""}).join(`
`),uo=()=>L()===i("gameConfig").engineColor?i("moveList").concat(ao):i("moveList"),mo=e=>w("move",N(e.move,e.legals,!0),"  "),go=()=>s("pending"),H=e=>{switch(e._tag){case"pending":return go();case"hist":return mo(e)}},de=()=>He(2,uo()).map((e,t)=>{const o=e[0],n=e[1];return o&&n?s("ply",w("ord",`${t+1}. `),w("moves",H(o),H(n))):o?s("ply",w("ord",`${t+1}.  `),w("moves",H(o))):s("empty")}),fe=()=>i("started")?u(s("button","Game"),e=>e("click",()=>a("screen","game"))):u(s("button","Home"),e=>e("click",()=>a("screen","home"))),po=()=>u(s("button","Copy PGN"),e=>e("click",()=>kt(io(i("moveList"))))),fo=e=>{const t=s("moves",...de()),o=s("back",fe());e.append(s("movelist",t,s("outcome",i("outcome")??"..."),s("actions",po(),o)));const n=g(t),c=g(o),r=p("moveList"),l=p("started");r(()=>{n(...de())}),l(()=>{c(fe())})},ho=(e,t)=>{const o=document.location.hostname,n=document.location.protocol,c=document.location.port.length>0&&document.location.port!=="8000"?"8000":document.location.port,r=Se(()=>c.length>0?G(`${n}//${o}:${c}${e}`,t):G(`${n}//${o}${e}`,t));return fetch(r,{mode:"cors",cache:"default",redirect:"follow",credentials:"same-origin"}).then(l=>{if(l.ok)return l.json();throw l}).catch(l=>console.error("failed to get eco",l))},ko=e=>ho("/eco",{term:e}).then(t=>a("ecoResult",t.sort((o,n)=>{const c=o.code.localeCompare(n.code);return c===0?o.moves.length-n.moves.length:c}))),wo=e=>{f("gameConfig",t=>({...t,position:e.fen})),X().then(()=>{Y(e.moves.map(t=>Q(t,[]))),a("screen","game")}).catch(t=>console.error("Connectin failed",t))},_o=e=>s("item",s("names",s("code",e.code),s("name",e.name)),s("actions",s("moves",e.pgn),u(s("play","▶"),t=>t("click",()=>wo(e))))),Co=e=>{_(e),e.append(...i("ecoResult").map(_o))},bo=()=>{const e=s("listing"),t=()=>{g(e)(s("loader","searching..."));const c=o.value;c.length>0&&ko(c).then(()=>{o.blur(),o.value=""})},o=u(J("i","search"),c=>c("change",t)),n=s("lookup",o,u(s("go-button","search"),c=>c("click",t)));return p("ecoResult")(()=>Co(e)),s("eco",s("help","Lookup an opening  by name."),n,e)},vo="00:01",No="02:00",{floor:he}=Math,xe=()=>X().then(()=>{Y(),a("screen","game")}).catch(e=>console.error("Connectin failed",e)),Eo=u(s("button-play","play"),e=>e("click",xe)),W=e=>{const t=e/1e3,o=he(t/60%60),n=he(t/60/60),c=o<10?`0${o.toFixed(0)}`:`${o.toFixed(0)}`;return`${n<10?`0${n.toFixed(0)}`:`${n.toFixed(0)}`}:${c}`},Po=e=>{const[t,o]=e.split(":").map(n=>parseInt(n));return(t*60*60+o*60)*1e3},ke=(e,t)=>u(I(J("input-time","time"),o=>{o("min",vo),o("max",No),o("value",W(e))}),o=>o("change",n=>{const c=n.currentTarget;t(Po(c.value))})),$o=()=>{const e=J("input-fen","text"),t=u(s("ok-button","Start with position"),o=>o("click",()=>{f("gameConfig",n=>({...n,position:e.value})),xe()}));return s("position",s("help","Starting posititon in FEN format."),s("fen-box",e,t))},Lo=e=>{const t=i("gameConfig"),o=u(s(`color ${t.engineColor}`,t.engineColor),r=>r("click",()=>{const l=x(i("gameConfig").engineColor);f("gameConfig",m=>({...m,black:m.white,white:m.black,engineColor:l})),o.classList.remove(x(l)),o.classList.add(l),g(o)(l)})),n=ke(t.white,r=>f("gameConfig",l=>({...l,white:r}))),c=ke(t.black,r=>f("gameConfig",l=>({...l,black:r})));p("gameConfig")(()=>{const{white:r,black:l}=i("gameConfig");n.value=W(r),c.value=W(l)}),e.append(s("config",s("main",s("engine-color",s("label","Engine color"),o),s("times",s("time","White time ",n),s("time","Black time ",c)),Eo),bo(),$o()))},Io=e=>t=>t&&document.location.hostname!=="localhost"?e.requestFullscreen().then(()=>console.log("enter fullscreen")).catch(o=>console.warn("failed to enter fullscreen",o)):document.exitFullscreen().then(()=>console.log("exir fullscreen")).catch(o=>console.warn("failed to exit fullscreen",o)),yo=e=>{lo(),pe(e);const t=Io(e);let o=["screen","lockScreen"];p("screen")(()=>{switch(rt(n=>o.includes(n)),_(e),i("screen")){case"home":return t(!1),pe(e);case"config":return t(!1),Lo(e);case"game":return t(!0),to(e);case"movelist":return t(!1),fo(e)}})};$e(yo)(ut(document.querySelector("#app")));
