(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function o(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=o(r);fetch(r.href,s)}})();const J="none",U="some",j={tag:J},V=e=>({tag:U,value:e}),ge=e=>typeof e=="object"&&e!==null&&"tag"in e&&(e.tag===J||e.tag===U),de=e=>e.tag==="none",z=e=>t=>de(t)?j:V(e(t.value)),he=e=>e==null?j:V(e),X=[{_tag:"Normal",role:"Pawn",from:"A2",capture:null,to:"A3",promotion:null},{_tag:"Normal",role:"Pawn",from:"A2",capture:null,to:"A4",promotion:null},{_tag:"Normal",role:"Knight",from:"B1",capture:null,to:"C3",promotion:null},{_tag:"Normal",role:"Pawn",from:"B2",capture:null,to:"B3",promotion:null},{_tag:"Normal",role:"Pawn",from:"B2",capture:null,to:"B4",promotion:null},{_tag:"Normal",role:"Pawn",from:"C2",capture:null,to:"C3",promotion:null},{_tag:"Normal",role:"Pawn",from:"C2",capture:null,to:"C4",promotion:null},{_tag:"Normal",role:"Pawn",from:"D2",capture:null,to:"D3",promotion:null},{_tag:"Normal",role:"Pawn",from:"D2",capture:null,to:"D4",promotion:null},{_tag:"Normal",role:"Pawn",from:"E2",capture:null,to:"E3",promotion:null},{_tag:"Normal",role:"Pawn",from:"E2",capture:null,to:"E4",promotion:null},{_tag:"Normal",role:"Pawn",from:"F2",capture:null,to:"F3",promotion:null},{_tag:"Normal",role:"Pawn",from:"F2",capture:null,to:"F4",promotion:null},{_tag:"Normal",role:"Knight",from:"G1",capture:null,to:"F3",promotion:null},{_tag:"Normal",role:"Knight",from:"G1",capture:null,to:"H3",promotion:null},{_tag:"Normal",role:"Pawn",from:"G2",capture:null,to:"G3",promotion:null},{_tag:"Normal",role:"Pawn",from:"G2",capture:null,to:"G4",promotion:null},{_tag:"Normal",role:"Pawn",from:"H2",capture:null,to:"H3",promotion:null},{_tag:"Normal",role:"Pawn",from:"H2",capture:null,to:"H4",promotion:null}],u=e=>e[0],K=e=>e[1],Y=e=>{switch(e._tag){case"Castle":return"King";case"EnPassant":return"Pawn";case"Normal":return e.role}},Z=e=>e==="black"?"white":"black",_e=()=>({_tag:"initial"}),ee=(e,t,o,n)=>({_tag:"running",turn:e,start_time:t,remaining_white:o,remaining_black:n}),T=(e,t)=>({_tag:"flag",color:e,other:t}),M=(e,t)=>({legalMoves:t,turn:e}),y=()=>({_tag:"none"}),ke=e=>({_tag:"role",role:e}),we=e=>({_tag:"move",move:e}),be=e=>{switch(e._tag){case"none":return null;case"role":return e.role;case"move":return Y(e.move)}},Ne=()=>({_tag:"idle"}),ve=()=>({_tag:"compute"}),Pe=(e,t)=>({_tag:"move",move:e,legals:t}),Ce=()=>Ne(),te=(e,t)=>({move:e,legals:t}),Ee=()=>y(),Le=()=>M("white",X),Oe=()=>"home",Ke=()=>[],Se=()=>_e();let E={screen:Oe(),moveList:Ke(),clock:Se(),position:Le(),input:Ee(),started:!1,engine:Ce(),lockScreen:!1,outcome:null},k=[];const d=(e,t)=>{let o=a(e);return E[e]=t(o),e!=="clock"&&(console.groupCollapsed(e),console.debug("from",o),console.debug("to",E[e]),console.groupEnd()),k.filter(([n,r])=>n==e).map(([n,r])=>r(e)),a(e)},l=(e,t)=>d(e,()=>t),a=e=>JSON.parse(JSON.stringify(E[e])),Ie=()=>Object.keys(E),b=(...e)=>t=>k=k.concat(e.map(o=>[o,t])),Me=e=>k=k.filter(([t,o])=>e(t)),h=(e,t)=>(t((n,r)=>{e.addEventListener(n,r)}),e);function g(e){for(;e.firstChild;)ye(e.firstChild);return e}function ye(e,t=!1){t||g(e);const o=e.parentNode;o&&o.removeChild(e)}const $e=e=>document.createElement(e),A=e=>t=>t.appendChild(document.createTextNode(e)),Be=(e,t)=>{const o=$e(e);return o.setAttribute("class",t),o},Te=e=>t=>{typeof t=="number"?A(t.toLocaleString())(e):A(t)(e)},Ae=e=>t=>{e.appendChild(t)},H=(e,t)=>{typeof t=="number"||typeof t=="string"?Te(e)(t):Ae(e)(t)},oe=e=>t=>{ge(t)?z(o=>H(e,o))(t):H(e,t)},w=e=>(...t)=>{const o=oe(e);g(e),t.forEach(o)},He=e=>t=>t.classList.contains(e),Fe=e=>t=>t.classList.add(e),xe=e=>t=>t.classList.remove(e),ne=(e,t,o)=>{const n=Be(e,t);return o.forEach(oe(n)),n},c=(e,...t)=>ne("div",e,t),p=(e,...t)=>ne("span",e,t),Re=e=>e(),$=c("time white active","--:--"),B=c("time black","--:--"),Ge=e=>{e.append(c("clock",$,B)),R(),b("clock")(R)},re=()=>d("clock",e=>e._tag=="running"?(x($),x(B),le({...e,turn:Z(e.turn)})):e);let se=null;const F=()=>clearInterval(se??void 0),We=(e,t)=>{const o=Date.now();m=0,P=e,f=0,C=t,F(),se=setInterval(()=>d("clock",n=>{const r=le(n);return r._tag==="flag"&&F(),r}),100),l("clock",ee("white",o,0,0))};let m=0,f=0,P=0,C=0;const{floor:S}=Math,v=e=>{const t=e/1e3,o=S(t%60),n=S(t/60%60),r=S(t/60/60),s=o<10?`0${o.toFixed(0)}`:`${o.toFixed(0)}`,i=n<10?`0${n.toFixed(0)}`:`${n.toFixed(0)}`,N=r<10?`0${r.toFixed(0)}`:`${r.toFixed(0)}`;return t>=3600?`${N}:${i}:${s}`:`${i}:${s}`},De=xe("active"),Qe=Fe("active"),qe=He("active"),x=e=>qe(e)?De(e):Qe(e),R=()=>{const e=w($),t=w(B),o=a("clock");switch(o._tag){case"flag":{o.color==="white"?(e("flag"),t(v(o.other))):(t("flag"),e(v(o.other)));break}case"running":{t(v(o.remaining_black)),e(v(o.remaining_white));break}case"initial":{t("--:--"),e("--:--");break}}},le=e=>{if(e._tag==="running"){let t=Date.now(),o=m+f,r=t-e.start_time-o;return Re(()=>{switch(e.turn){case"white":return m+=r;case"black":return f+=r}}),f>=C?T("black",P-m):m>=P?T("white",C-f):ee(e.turn,e.start_time,P-m,C-f)}return{...e}},Je=["Pawn","Bishop","Knight","Rook","Queen","King"],Ue="♟",je="♜",Ve="♞",ze="♝",Xe="♛",Ye="♚",ce="♙",ae="♖",ie="♘",ue="♗",pe="♕",me="♔",I=(e,t,o,n=null,r=null,s=null)=>({_tag:"Normal",role:e,capture:t,to:o,rank:n,file:r,promotion:s}),G=e=>({_tag:"Castle",side:e}),Ze=(e,t,o)=>e.filter(n=>{switch(n._tag){case"Castle":return!1;case"EnPassant":return t=="Pawn"&&n.to===o;default:return o===n.to&&t===n.role}}),et=(e,t)=>{switch(e._tag){case"Normal":{if(e.role==="Pawn")return I("Pawn",e.capture!==null,e.to,null,e.capture!==null?u(e.from):null,e.promotion);{let o=!1,n=!1,r=!1;for(const s of t)s._tag==="Normal"&&e.from!=s.from&&e.role==s.role&&e.to==s.to&&e.promotion==s.promotion&&(o=!0,K(e.from)==K(s.from)&&(r=!0),u(e.from)==u(s.from)&&(n=!0));return I(e.role,e.capture!==null,e.to,n?K(e.from):null,o&&(!n||r)?u(e.from):null,e.promotion)}}case"EnPassant":return I("Pawn",!0,e.to,null,u(e.from),null);case"Castle":return u(e.rook)<u(e.king)?G("QueenSide"):G("KingSide")}},W=e=>e[0],D=e=>{switch(e){case"Pawn":return ce;case"Rook":return ae;case"Knight":return ie;case"Bishop":return ue;case"Queen":return pe;case"King":return me}},tt=(e,t)=>{let o=[];return t._tag==="Normal"&&t.role!=="Pawn"&&(o=Ze(e,t.role,t.to)),et(t,o)},ot=(e,t)=>{const o=[];switch(e._tag){case"Normal":{e.role!=="Pawn"&&o.push(t?D(e.role):W(e.role)),e.file!==null&&o.push(e.file.toLowerCase()),e.rank!==null&&o.push(e.rank),e.capture&&o.push("x"),o.push(e.to.toLowerCase()),e.promotion!==null&&o.push("=",t?D(e.promotion):W(e.promotion));break}case"Castle":{e.side==="KingSide"?o.push("O","-","O"):o.push("O","-","O","-","O");break}case"null":o.push("--")}return o.join("")},L=(e,t,o=!0)=>ot(tt(t,e),o),Q=e=>{const t=w(e),o=a("engine");switch(o._tag){case"idle":return t("·");case"compute":return t(c("compute"));case"move":return t(L(o.move,o.legals))}},nt=e=>{const t=h(c("engine"),o=>o("click",()=>l("screen","movelist")));Q(t),b("engine")(()=>Q(t)),e.append(t)};let _=null;const rt=()=>{const e=document.location.hostname,t=e!=="localhost"&&e!=="127.0.0.1"?"wss":"ws",o=document.location.port.length>0&&document.location.port!=="8000"?"8000":document.location.port;return o.length>0?`${t}://${e}:${o}/play`:`${t}://${e}/play`},st=e=>{console.log("handlePosition",e),l("position",M("white",e.legalMoves))},lt=e=>{console.log("handleEngineMove",e),re();const t=a("position").legalMoves;d("moveList",o=>o.concat(te(e.move,t))),l("engine",Pe(e.move,t))},ct=e=>{console.log("handleOutcome",e),console.log("Outcome",e.outcome),l("started",!1),l("outcome",e.outcome),l("screen","movelist")},at=e=>t=>{const o=JSON.parse(t.data);switch(o._tag){case"Ready":return l("started",!0),e(),console.log("server ready");case"Position":return st(o);case"EngineMove":return lt(o);case"Outcome":return ct(o)}},it=2e3,ut=()=>new Promise((e,t)=>{const o=setTimeout(()=>t("Timeout error"),it);_=new WebSocket(rt()),_.addEventListener("message",at(()=>{clearTimeout(o),e("Ready")})),_.addEventListener("close",()=>l("started",!1))}),pt=e=>{if(a("started"))if(_===null)console.error("sending move on null socket");else{const t=a("clock");l("engine",ve()),t._tag==="running"&&(_.send(JSON.stringify({_tag:"Move",move:e,white_time:t.remaining_white,black_time:t.remaining_black})),l("input",y()))}else console.error("game has not started")},mt=(e,t)=>{switch(e){case"Pawn":return t==="black"?Ue:ce;case"Rook":return t==="black"?je:ae;case"Knight":return t==="black"?Ve:ie;case"Bishop":return t==="black"?ze:ue;case"Queen":return t==="black"?Xe:pe;case"King":return t==="black"?Ye:me}},ft=(e,t)=>t.some(o=>{switch(o._tag){case"Normal":return o.role===e;case"Castle":return e==="King";case"EnPassant":return e==="Pawn"}}),gt=e=>e?"selected":"",dt=(e,t)=>Je.map(o=>h(c(`piece ${o}  ${gt(e===o)}`,mt(o,ft(o,t)?"black":"white")),n=>n("click",()=>l("input",ke(o))))),ht=(e,t)=>t.filter(o=>Y(o)===e).map(o=>h(c("move",L(o,t)),n=>n("click",()=>{re(),l("input",we(o)),d("moveList",r=>r.concat(te(o,a("position").legalMoves))),d("position",r=>({...r,turn:Z(r.turn)})),pt(o)}))),_t=e=>{const t=c("pieces"),o=c("moves"),n=c("input",o,t);e.append(n);const r=()=>{if(a("position").turn==="white"){const s=w(t),i=w(o),N=a("position"),O=a("input"),fe=be(O);s(...dt(fe,N.legalMoves)),O._tag==="role"?i(...ht(O.role,N.legalMoves)):g(o)}else g(o),g(t)};b("position","input")(r),r()},kt=(e,t)=>{l("position",M("white",X)),l("input",y()),l("moveList",[]),We(e,t)},wt=e=>{nt(e),_t(e),Ge(e)},q=e=>{e.append(h(c("button-play","play"),t=>t("click",()=>ut().then(()=>{kt(10*60*1e3,60*1e3),l("screen","game")}).catch(o=>console.error("Connectin failed",o)))))},bt="wakeLock"in navigator,Nt=()=>{if(bt){const e=b(...Ie());let t=null;e(()=>{const o=a("started"),n=a("lockScreen");o&&!n?navigator.wakeLock.request("screen").then(r=>{t=r,t.addEventListener("release",()=>{console.log("Navigator released lock sentinel"),l("lockScreen",!1)}),l("lockScreen",!0)}).catch(r=>console.error("failed to lock screen",r)):!o&&n&&t!==null&&t.release().then(()=>{t=null,l("lockScreen",!1)}).catch(r=>console.error("failed to release screen",r))})}},vt=(e,t)=>{const o=[[]];for(let n=0;n<t.length;n++){let r=Math.floor(n/e);r===o.length&&o.push([]),o[r].push(t[n])}return o},Pt=e=>{const t=vt(2,a("moveList")).map((n,r)=>{const s=L(n[0].move,n[0].legals,!1);if(n.length===2){const i=L(n[1].move,n[1].legals,!1);return c("ply",p("ord",`${r+1}.  `),p("moves",p("white",s),p("black",i)))}else return c("ply",p("ord",`${r+1}.  `),p("moves",p("white",s)))}),o=a("started")?h(c("back-button","back to game"),n=>n("click",()=>l("screen","game"))):h(c("back-button","back home"),n=>n("click",()=>l("screen","home")));e.append(c("movelist",...t,c("outcome",a("outcome")??"..."),o))},Ct=e=>t=>t?e.requestFullscreen().then(()=>console.log("enter fullscreen")).catch(o=>console.error("failed to enter fullscreen",o)):document.exitFullscreen().then(()=>console.log("exir fullscreen")).catch(o=>console.error("failed to exit fullscreen",o)),Et=e=>{Nt(),q(e);const t=Ct(e);let o=["screen","lockScreen"];b("screen")(()=>{switch(Me(n=>o.includes(n)),g(e),a("screen")){case"home":return t(!1),q(e);case"game":return t(!0),wt(e);case"movelist":return t(!1),Pt(e)}})};z(Et)(he(document.querySelector("#app")));
//# sourceMappingURL=index-BVMjhfhj.js.map
