(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const Q="none",J="some",j={tag:Q},q=e=>({tag:J,value:e}),pe=e=>typeof e=="object"&&e!==null&&"tag"in e&&(e.tag===Q||e.tag===J),me=e=>e.tag==="none",U=e=>t=>me(t)?j:q(e(t.value)),fe=e=>e==null?j:q(e),V=[{_tag:"Normal",role:"Pawn",from:"A2",capture:null,to:"A3",promotion:null},{_tag:"Normal",role:"Pawn",from:"A2",capture:null,to:"A4",promotion:null},{_tag:"Normal",role:"Knight",from:"B1",capture:null,to:"C3",promotion:null},{_tag:"Normal",role:"Pawn",from:"B2",capture:null,to:"B3",promotion:null},{_tag:"Normal",role:"Pawn",from:"B2",capture:null,to:"B4",promotion:null},{_tag:"Normal",role:"Pawn",from:"C2",capture:null,to:"C3",promotion:null},{_tag:"Normal",role:"Pawn",from:"C2",capture:null,to:"C4",promotion:null},{_tag:"Normal",role:"Pawn",from:"D2",capture:null,to:"D3",promotion:null},{_tag:"Normal",role:"Pawn",from:"D2",capture:null,to:"D4",promotion:null},{_tag:"Normal",role:"Pawn",from:"E2",capture:null,to:"E3",promotion:null},{_tag:"Normal",role:"Pawn",from:"E2",capture:null,to:"E4",promotion:null},{_tag:"Normal",role:"Pawn",from:"F2",capture:null,to:"F3",promotion:null},{_tag:"Normal",role:"Pawn",from:"F2",capture:null,to:"F4",promotion:null},{_tag:"Normal",role:"Knight",from:"G1",capture:null,to:"F3",promotion:null},{_tag:"Normal",role:"Knight",from:"G1",capture:null,to:"H3",promotion:null},{_tag:"Normal",role:"Pawn",from:"G2",capture:null,to:"G3",promotion:null},{_tag:"Normal",role:"Pawn",from:"G2",capture:null,to:"G4",promotion:null},{_tag:"Normal",role:"Pawn",from:"H2",capture:null,to:"H3",promotion:null},{_tag:"Normal",role:"Pawn",from:"H2",capture:null,to:"H4",promotion:null}],u=e=>e[0],K=e=>e[1],z=e=>{switch(e._tag){case"Castle":return"King";case"EnPassant":return"Pawn";case"Normal":return e.role}},X=e=>e==="black"?"white":"black",ge=()=>({_tag:"initial"}),Y=(e,t,o,r)=>({_tag:"running",turn:e,start_time:t,remaining_white:o,remaining_black:r}),A=(e,t)=>({_tag:"flag",color:e,other:t}),I=(e,t)=>({legalMoves:t,turn:e}),M=()=>({_tag:"none"}),de=e=>({_tag:"role",role:e}),he=e=>({_tag:"move",move:e}),_e=e=>{switch(e._tag){case"none":return null;case"role":return e.role;case"move":return z(e.move)}},we=()=>({_tag:"idle"}),ke=()=>({_tag:"compute"}),Ne=(e,t)=>({_tag:"move",move:e,legals:t}),ve=()=>we(),Z=(e,t)=>({move:e,legals:t}),be=()=>M(),Pe=()=>I("white",V),Ce=()=>"home",Ee=()=>[],Le=()=>ge();let C={screen:Ce(),moveList:Ee(),clock:Le(),position:Pe(),input:be(),started:!1,engine:ve(),lockScreen:!1,outcome:null},_=[];const d=(e,t)=>{let o=C[e];return C[e]=t(o),_.filter(([r,n])=>r==e).map(([r,n])=>n(e)),a(e)},l=(e,t)=>d(e,()=>t),a=e=>JSON.parse(JSON.stringify(C[e])),Oe=()=>Object.keys(C),k=(...e)=>t=>_=_.concat(e.map(o=>[o,t])),Ke=e=>_=_.filter(([t,o])=>e(t)),L=(e,t)=>(t((r,n)=>{e.addEventListener(r,n)}),e);function g(e){for(;e.firstChild;)ye(e.firstChild);return e}function ye(e,t=!1){t||g(e);const o=e.parentNode;o&&o.removeChild(e)}const Se=e=>document.createElement(e),H=e=>t=>t.appendChild(document.createTextNode(e)),Ie=(e,t)=>{const o=Se(e);return o.setAttribute("class",t),o},Me=e=>t=>{typeof t=="number"?H(t.toLocaleString())(e):H(t)(e)},$e=e=>t=>{e.appendChild(t)},F=(e,t)=>{typeof t=="number"||typeof t=="string"?Me(e)(t):$e(e)(t)},ee=e=>t=>{pe(t)?U(o=>F(e,o))(t):F(e,t)},w=e=>(...t)=>{const o=ee(e);g(e),t.forEach(o)},Be=e=>t=>t.classList.contains(e),Ae=e=>t=>t.classList.add(e),He=e=>t=>t.classList.remove(e),te=(e,t,o)=>{const r=Ie(e,t);return o.forEach(ee(r)),r},c=(e,...t)=>te("div",e,t),p=(e,...t)=>te("span",e,t),Fe=e=>e(),$=c("time white active","--:--"),B=c("time black","--:--"),Ge=e=>{e.append(c("clock",$,B)),R(),k("clock")(R)},oe=()=>d("clock",e=>e._tag=="running"?(G($),G(B),ne({...e,turn:X(e.turn)})):e),Re=(e,t)=>{const o=Date.now();m=0,b=e,f=0,P=t;let r=setInterval(()=>d("clock",n=>{const s=ne(n);return s._tag==="flag"&&clearInterval(r),s}),100);l("clock",Y("white",o,0,0))};let m=0,f=0,b=0,P=0;const{floor:y}=Math,v=e=>{const t=e/1e3,o=y(t%60),r=y(t/60%60),n=y(t/60/60),s=o<10?`0${o.toFixed(0)}`:`${o.toFixed(0)}`,i=r<10?`0${r.toFixed(0)}`:`${r.toFixed(0)}`,N=n<10?`0${n.toFixed(0)}`:`${n.toFixed(0)}`;return t>=3600?`${N}:${i}:${s}`:`${i}:${s}`},We=He("active"),xe=Ae("active"),Te=Be("active"),G=e=>Te(e)?We(e):xe(e),R=()=>{const e=w($),t=w(B),o=a("clock");switch(o._tag){case"flag":{o.color==="white"?(e("flag"),t(v(o.other))):(t("flag"),e(v(o.other)));break}case"running":{t(v(o.remaining_black)),e(v(o.remaining_white));break}case"initial":{t("--:--"),e("--:--");break}}},ne=e=>{if(e._tag==="running"){let t=Date.now(),o=m+f,n=t-e.start_time-o;return Fe(()=>{switch(e.turn){case"white":return m+=n;case"black":return f+=n}}),f>=P?A("black",b-m):m>=b?A("white",P-f):Y(e.turn,e.start_time,b-m,P-f)}return{...e}};let h=null;const De=()=>{const e=document.location.hostname,t=document.location.protocol.endsWith("s")?"wss":"ws",o=document.location.port.length>0&&document.location.port!=="8000"?"8000":document.location.port;return o.length>0?`${t}://${e}:${o}/play`:`${t}://${e}/play`},Qe=e=>{console.log("handlePosition",e),l("position",I("white",e.legalMoves))},Je=e=>{console.log("handleEngineMove",e),oe();const t=a("position").legalMoves;d("moveList",o=>o.concat(Z(e.move,t))),l("engine",Ne(e.move,t))},je=e=>{console.log("handleOutcome",e),console.log("Outcome",e.outcome),l("outcome",e.outcome),l("screen","movelist")},qe=e=>{const t=JSON.parse(e.data);switch(t._tag){case"Ready":return l("started",!0),console.log("server ready");case"Position":return Qe(t);case"EngineMove":return Je(t);case"Outcome":return je(t)}},Ue=()=>{h=new WebSocket(De()),h.addEventListener("message",qe),h.addEventListener("close",()=>l("started",!1))},Ve=e=>{if(a("started"))if(h===null)console.error("sending move on null socket");else{const t=a("clock");l("engine",ke()),t._tag==="running"&&(h.send(JSON.stringify({_tag:"Move",move:e,white_time:t.remaining_white,black_time:t.remaining_black})),l("input",M()))}else console.error("game has not started")},W=e=>{e.append(L(c("button-play","play"),t=>t("click",()=>{Ue(),l("screen","game")})))},ze=["Pawn","Bishop","Knight","Rook","Queen","King"],Xe="♟",Ye="♜",Ze="♞",et="♝",tt="♛",ot="♚",re="♙",se="♖",le="♘",ce="♗",ae="♕",ie="♔",S=(e,t,o,r=null,n=null,s=null)=>({_tag:"Normal",role:e,capture:t,to:o,rank:r,file:n,promotion:s}),x=e=>({_tag:"Castle",side:e}),nt=(e,t,o)=>e.filter(r=>{switch(r._tag){case"Castle":return!1;case"EnPassant":return t=="Pawn"&&r.to===o;default:return o===r.to&&t===r.role}}),rt=(e,t)=>{switch(e._tag){case"Normal":{if(e.role==="Pawn")return S("Pawn",e.capture!==null,e.to,null,e.capture!==null?u(e.from):null,e.promotion);{let o=!1,r=!1,n=!1;for(const s of t)s._tag==="Normal"&&e.from!=s.from&&e.role==s.role&&e.to==s.to&&e.promotion==s.promotion&&(o=!0,K(e.from)==K(s.from)&&(n=!0),u(e.from)==u(s.from)&&(r=!0));return S(e.role,e.capture!==null,e.to,r?K(e.from):null,o&&(!r||n)?u(e.from):null,e.promotion)}}case"EnPassant":return S("Pawn",!0,e.to,null,u(e.from),null);case"Castle":return u(e.rook)<u(e.king)?x("QueenSide"):x("KingSide")}},T=e=>e[0],D=e=>{switch(e){case"Pawn":return re;case"Rook":return se;case"Knight":return le;case"Bishop":return ce;case"Queen":return ae;case"King":return ie}},st=(e,t)=>{let o=[];return t._tag==="Normal"&&t.role!=="Pawn"&&(o=nt(e,t.role,t.to)),rt(t,o)},lt=(e,t)=>{const o=[];switch(e._tag){case"Normal":{e.role!=="Pawn"&&o.push(t?D(e.role):T(e.role)),e.file!==null&&o.push(e.file.toLowerCase()),e.rank!==null&&o.push(e.rank),e.capture&&o.push("x"),o.push(e.to.toLowerCase()),e.promotion!==null&&o.push("=",t?D(e.promotion):T(e.promotion));break}case"Castle":{e.side==="KingSide"?o.push("O","-","O"):o.push("O","-","O","-","O");break}case"null":o.push("--")}return o.join("")},E=(e,t,o=!0)=>lt(st(t,e),o),ct=e=>{const t=c("engine"),o=w(t);k("engine")(()=>{const r=a("engine");switch(r._tag){case"idle":return o("·");case"compute":return o(c("compute"));case"move":return o(E(r.move,r.legals))}}),e.append(t)},at=(e,t)=>{switch(e){case"Pawn":return t==="black"?Xe:re;case"Rook":return t==="black"?Ye:se;case"Knight":return t==="black"?Ze:le;case"Bishop":return t==="black"?et:ce;case"Queen":return t==="black"?tt:ae;case"King":return t==="black"?ot:ie}},it=(e,t)=>t.some(o=>{switch(o._tag){case"Normal":return o.role===e;case"Castle":return e==="King";case"EnPassant":return e==="Pawn"}}),ut=e=>e?"selected":"",pt=(e,t)=>ze.map(o=>L(c(`piece ${o}  ${ut(e===o)}`,at(o,it(o,t)?"black":"white")),r=>r("click",()=>l("input",de(o))))),mt=(e,t)=>t.filter(o=>z(o)===e).map(o=>L(c("move",E(o,t)),r=>r("click",()=>{oe(),l("input",he(o)),d("moveList",n=>n.concat(Z(o,a("position").legalMoves))),d("position",n=>({...n,turn:X(n.turn)})),Ve(o)}))),ft=e=>{const t=c("pieces"),o=c("moves"),r=c("input",o,t);e.append(r);const n=()=>{if(a("position").turn==="white"){const s=w(t),i=w(o),N=a("position"),O=a("input"),ue=_e(O);s(...pt(ue,N.legalMoves)),O._tag==="role"?i(...mt(O.role,N.legalMoves)):g(o)}else g(o),g(t)};k("position","input")(n),n()},gt=()=>{l("position",I("white",V)),l("input",M()),l("moveList",[])},dt=e=>{ct(e),ft(e),Ge(e),Re(60*10*1e3,60*1e3),gt()},ht="wakeLock"in navigator,_t=()=>{if(ht){const e=k(...Oe());let t=null;e(()=>{const o=a("started"),r=a("lockScreen");o&&!r?navigator.wakeLock.request("screen").then(n=>{t=n,t.addEventListener("release",()=>{console.log("Navigator released lock sentinel"),l("lockScreen",!1)}),l("lockScreen",!0)}).catch(n=>console.error("failed to lock screen",n)):!o&&r&&t!==null&&t.release().then(()=>{t=null,l("lockScreen",!1)}).catch(n=>console.error("failed to release screen",n))})}},wt=(e,t)=>{const o=[[]];for(let r=0;r<t.length;r++){let n=Math.floor(r/e);n===o.length&&o.push([]),o[n].push(t[r])}return o},kt=e=>{const t=wt(2,a("moveList")).map((o,r)=>{const n=E(o[0].move,o[0].legals,!1);if(o.length===2){const s=E(o[1].move,o[1].legals,!1);return c("ply",p("ord",`${r+1}.  `),p("moves",p("white",n),p("black",s)))}else return c("ply",p("ord",`${r+1}.  `),p("moves",p("white",n)))});e.append(c("movelist",...t,c("outcome",a("outcome")??"..."),L(c("back-button","back home"),o=>o("click",()=>l("screen","home")))))},Nt=e=>{_t(),W(e),k("screen")(()=>{switch(Ke(t=>t==="screen"),g(e),a("screen")){case"home":return W(e);case"game":return dt(e);case"movelist":return kt(e)}})};U(Nt)(fe(document.querySelector("#app")));
//# sourceMappingURL=index-CRAAFMET.js.map
